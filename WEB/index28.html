<html>    <head>    <title>生产者-消费者模式</title>    <meta content='width=device-width, initial-scale=1.0, user-scalable=no' name='viewport'><meta content='text/html; charset=utf-8' http-equiv='content-type' /><link href='/styles/github.css' rel='stylesheet' type='text/css' /><script src='/javascripts/highlight.pack.js' type='text/javascript'></script><link href='/images/fav.png' rel='shortcut icon'><link href='/stylesheets/style.css' rel='stylesheet' type='text/css' /><link href='/stylesheets/syntax.css' rel='stylesheet' type='text/css' /><link href='/stylesheets/responsive.css' rel='stylesheet' type='text/css' /><link href="/stylesheets/nprogress.css" rel='stylesheet' type='text/css' /><link href="/stylesheets/duoshuo.css" rel='stylesheet' type='text/css' /><link href="/feed.xml" rel="alternate" type="application/rss+xml"><script src='/javascripts/jquery.js' type='text/javascript'></script><script src='/javascripts/jquery.particleground.min.js' type='text/javascript'></script><script src='/javascripts/nprogress.js' type='text/javascript'></script><script src='/javascripts/theater.js' type='text/javascript'></script><script src='/javascripts/app.js' type='text/javascript'></script><script>    hljs.initHighlightingOnLoad();    var duoshuoQuery = {short_name:"kbasha"};</script>    </head>    <body>        <header><div id="blog-desc">    If you want do, then do.</div></header><div id="main">    <div id="left">    <a id="head-pic" class="go-back-home" href="/"><img src="../images/kbasha.jpg" alt="Home" width="100" height="100"></a>    <p>克巴沙</p>        <ul id="titles" class="titles">                    </ul>    </div>    <div id="right">    <a id="scaner-pic" class="go-back-home" href="/"><img src="../images/kbasha_id.jpg" alt="Home" width="172" height="172"></a>    <p>关注公众号</p>            </div>        <div id='container'>                        <div class="block nav">    <ul>            <li>            <span class="line line-top"></span>            <span class="line line-right"></span>            <span class="line line-bottom"></span>            <span class="line line-left"></span>            <a target="_top" href="/about.html">About</a>        </li>            <li>            <span class="line line-top"></span>            <span class="line line-right"></span>            <span class="line line-bottom"></span>            <span class="line line-left"></span>            <a target="_top" href="/">Blog</a>        </li>        <li>            <span class="line line-top"></span>            <span class="line line-right"></span>            <span class="line line-bottom"></span>            <span class="line line-left"></span>            <a target="_blank" href="https://github.com/kebasha">GitHub</a>        </li>            </ul></div>            <section class="paging">      <div class="left">      <a href="index27.html">        ‹      </a>    </div>      <div class="right">      <a href="index29.html">        ›      </a>    </div>  </section><div class="content">    <section class='post'>        <h1>            生产者-消费者模式            <div class='date'>2016-03-30 23:38:58</div>        </h1>      <blockquote><p style="text-indent:2em;">生产者-消费者模式是一个经典的多线程设计模式，它为多线程间的协作提供了良好的解决方案。在生产者-消费者模式中，通常有两类线程，即若干个生产者线程和若干个消费者线程。生产者线程负责提交用户请求，消费者线程则负责具体处理生产者提交的任务。生产者和消费者之间通过共享内在缓冲区进行通信。如下图所示，展示了生产者-消费者模式的基本结构。3个生产者线程将任务提交到共享内存缓冲区，消费者线程并不直接与生产者线程通信，而在共享内存缓冲区中获取任务，并进行处理。</p><img src="index28_01.png"><p style="text-indent:2em;">和产者-消费者模式的核心组件是共享内存缓冲区，它作为生产者和消费者间的通信桥梁，避免了生产者和消费者的直接通信，从而将生产者和消费者进行解耦。生产者不需要知道消费者的存在，消费者也不需要知道生产者的存在。</p><p style="text-indent:2em;">同时，由于内存缓冲区的存在，允许生产者和消费者在执行速度上存在时间差，无论是生产者在某一局部时间内速度高于消费者，或是消费者在局部时间内高于生产者，都可以通过共享内存缓冲区得到级解，确保系统正常运行。</p><img src="index28_02.png"></blockquote><pre><code class="java">import java.util.Random;import java.util.concurrent.BlockingQueue;import java.util.concurrent.TimeUnit;import java.util.concurrent.atomic.AtomicInteger;public class Producer implements Runnable {    private volatile boolean isRunning = true;    private BlockingQueue&lt;PCData&gt; queue;    private static AtomicInteger count = new AtomicInteger();    private static final int SLEEPTIME = 1000;    public Producer(BlockingQueue&lt;PCData&gt; queue){       this.queue = queue;    }    public void run() {       PCData data = null;       Random r = new Random();       System.out.println("start producer Id="+Thread.currentThread().getId());       try {           while(isRunning){              Thread.sleep(r.nextInt(SLEEPTIME));              data = new PCData(count.incrementAndGet());//构造任务数据              System.out.println(data+" is put into queue");              if(!queue.offer(data, 2, TimeUnit.SECONDS)){                  System.err.println("failed to put data: " + data);              }           }       } catch (Exception e) {           e.printStackTrace();           Thread.currentThread().interrupt();       }    }    public void stop(){       isRunning = false;    }}</code></pre><pre><code class="java">import java.text.MessageFormat;import java.util.Random;import java.util.concurrent.BlockingQueue;public class Consumer implements Runnable {    private BlockingQueue<PCData> queue;    private static final int SLEEPTIME = 1000;    public Consumer(BlockingQueue<PCData> queue){       this.queue = queue;    }    public void run() {       System.out.println("start Consumer id=" + Thread.currentThread().getId());       Random r = new Random();       try {           while(true){              PCData data = queue.take();              if(null != data){                  int re = data.getData() * data.getData();                  System.out.println(MessageFormat.format("{0}*{1}={2}", data.getData(),data.getData(),re));                  Thread.sleep(r.nextInt(SLEEPTIME));              }           }       } catch (Exception e) {           e.printStackTrace();           Thread.currentThread().interrupt();       }    }}public class PCData {    private final int intData;    public PCData(int d){       intData = d;    }    public PCData(String d){       intData = Integer.valueOf(d);    }    public int getData(){       return intData;    }    @Override    public String toString() {       return "data:" + intData;    }}</code></pre><pre><code class="java">import java.util.concurrent.BlockingQueue;import java.util.concurrent.ExecutorService;import java.util.concurrent.Executors;import java.util.concurrent.LinkedBlockingQueue;public class Main {    /**     * @param args     * @throws InterruptedException     */    public static void main(String[] args) throws InterruptedException {       //建立缓冲区       BlockingQueue&lt;PCData&gt; queue = new LinkedBlockingQueue&lt;PCData&gt;(10);       Producer producer1 = new Producer(queue);       Producer producer2 = new Producer(queue);       Producer producer3 = new Producer(queue);       Consumer consumer1 = new Consumer(queue);       Consumer consumer2 = new Consumer(queue);       Consumer consumer3 = new Consumer(queue);       ExecutorService service = Executors.newCachedThreadPool();//建立线程池       service.execute(producer1);       service.execute(producer2);       service.execute(producer3);       service.execute(consumer2);       service.execute(consumer3);       service.execute(consumer1);       Thread.sleep(1000);       producer1.stop();       producer2.stop();       producer3.stop();       Thread.sleep(3000);       service.shutdown();    }}</code></pre><blockquote><p style="text-indent:2em;">注意：生产者-消费者模式能够很好地对生产者线程和消费者线程进行解耦，优化了系统整体结构。同时，由于缓冲区的作用，允许生产者线程和消费者线程存在执行上的性能差异，从一定程序上缓解了性能瓶颈对系统性能的影响。</p></blockquote>                </section>            </div>                    </div></div>        <script>            jQuery(document).ready(function($) {                App.mapKeySupport();                App.initNProgress();                App.initDuoshuo();                App.initTheater();            });        </script>    </body>    <div id="particles">    <canvas class="pg-canvas"></canvas></div><script type="text/javascript">    var _hmt = _hmt || [];    (function() {      var hm = document.createElement("script");      hm.src = "//hm.baidu.com/hm.js?93757bc26a1b57b9c6a7771db256d254";      var s = document.getElementsByTagName("script")[0];       s.parentNode.insertBefore(hm, s);    })();    $(function(){        var $body = $("body");        $("#particles").css({                "width":$body.width(),                 "height":$body.height()            }).particleground({                lineColor: '#e0e0e0',                dotColor: '#EFEFEF',                lineColor: '#EFEFEF',                   minSpeedX :0.5,                maxSpeedX :1,                minSpeedY : 0.5,                maxSpeedY :1            });    });</script><footer>  <span class="muted">© kbasha. All Rights Reserved.</span>  <br>  <br>  <!--img src="/images/scribble2.png" alt="scribble" /--></footer></html>